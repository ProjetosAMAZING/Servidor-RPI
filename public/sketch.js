// valores de rho correspondentes ao theta.
var y = [
   0.184545986438579,
   0.184276786088046,
   0.184005176649181,
   0.183727668846551,
   0.183440021134449,
   0.183137521381845,
   0.182815565923607,
   0.182470434546062,
   0.182100035271387,
   0.181704346761584,
   0.181285740371521,
   0.180846730164707,
   0.180387699135603,
   0.179905696834589,
   0.179396689840114,
   0.178856688981798,
   0.178283165474983,
   0.177675636053339,
   0.177034454849964,
   0.176362273467129,
   0.175663037703185,
   0.174942635553598,
   0.174211489996509,
   0.173483128378346,
   0.172772617454380,
   0.172094976808308,
   0.171461779268015,
   0.170879729700626,
   0.170353086103824,
   0.169883465519938,
   0.169470411973925,
   0.169114256338003,
   0.168816936448460,
   0.168581322063266,
   0.168410969622878,
   0.168308645812220,
   0.168273660214180,
   0.168303566745227,
   0.168395251360296,
   0.168544190631882,
   0.168745458369241,
   0.168992509135366,
   0.169278979641585,
   0.169600560841166,
   0.169954316370434,
   0.170341269368498,
   0.170764964399172,
   0.171229052203535,
   0.171737538396050,
   0.172294422699258,
   0.172903124586229,
   0.173567110212344,
   0.174290444289807,
   0.175077886727706,
   0.175933992561638,
   0.176860602623911,
   0.177858049455583,
   0.178927011731694,
   0.180070149757889,
   0.181294973384835,
   0.182609826869966,
   0.184021907981122,
   0.185537116434809,
   0.187159986953260,
   0.188895492826976,
   0.190748624997645,
   0.192719799984221,
   0.194805474035611,
   0.197001013591380,
   0.199300243414645,
   0.201696288464992,
   0.204181928749411,
   0.206748895420106,
   0.209384027611313,
   0.212068906398022,
   0.214778403707168,
   0.217483089285833,
   0.220154083674046,
   0.222764738385838,
   0.225288436252434,
   0.227696828664611,
   0.229961310922492,
   0.232058509562843,
   0.233971273117388,
   0.235683985453267,
   0.237182283070940,
   0.238452395141365,
   0.239482251969846,
   0.240262437441751,
   0.240785176810405,
   0.241045978948059,
   0.241043442236750,
   0.240778741206535,
   0.240255875263763,
   0.239481045575760,
   0.238464019635098,
   0.237215888147366,
   0.235747997362532,
   0.234071854616894,
   0.232201308138796,
   0.230155261201288,
   0.227958350069773,
   0.225637553953198,
   0.223219895252331,
   0.220733173451488,
   0.218206134755085,
   0.215666959349059,
   0.213139102580706,
   0.210640250453026,
   0.208187241972691,
   0.205794154564189,
   0.203473327428725,
   0.201235908909895,
   0.199088736895884,
   0.197035463804069,
   0.195076888281569,
   0.193213992250378,
   0.191450206073361,
   0.189784515458886,
   0.188211604922518,
   0.186726305425141,
   0.185323531659451,
   0.183997514648298,
   0.182742740121982,
   0.181555129378449,
   0.180431545743289,
   0.179368889691701,
   0.178366580824443,
   0.177429529950466,
   0.176563240390619,
   0.175773512977309,
   0.175060197171818,
   0.174420303108995,
   0.173849319001256,
   0.173340529316280,
   0.172888895553760,
   0.172492929433539,
   0.172152545474011,
   0.171870186254473,
   0.171649542117324,
   0.171495164592065,
   0.171411755284243,
   0.171400770377306,
   0.171460304983955,
   0.171586714712279,
   0.171776112072000,
   0.172024873017882,
   0.172329655696357,
   0.172685497174536,
   0.173086630225954,
   0.173526917347979,
   0.174000660902629,
   0.174504641857958,
   0.175035484469718,
   0.175586915590956,
   0.176152107970135,
   0.176725331364200,
   0.177301687204483,
   0.177875772458247,
   0.178442382777307,
   0.178995075602142,
   0.179526255525250,
   0.180028500291757,
   0.180495862718831,
   0.180922970521970,
   0.181303416027646,
   0.181632421467114,
   0.181910624446507,
   0.182142591402894,
   0.182333622049964,
   0.182489589567200,
   0.182617264089910,
   0.182722967232534,
   0.182812231001097,
   0.182889455980968,
   0.182956764813789,
   0.183013425959803,
   0.183057666246512,
   0.183088285433267,
   0.183104214492845,
   0.183104527413653,
   0.183088343234397,
   0.183054795642149,
   0.183003029466635,
   0.182932286306431,
   0.182842377524085,
   0.182733777113889,
   0.182605844555849,
   0.182455432304922,
   0.182278891229530,
   0.182071217134170,
   0.181826392279149,
   0.181538337008351,
   0.181201614445623,
   0.180811321917260,
   0.180365592012246,
   0.179866797999378,
   0.179321304266773,
   0.178735809615989,
   0.178117585095203,
   0.177473835501149,
   0.176811159790087,
   0.176136554645650,
   0.175457029486265,
   0.174779548036181,
   0.174111231266556,
   0.173460487830372,
   0.172836450034107,
   0.172246533258835,
   0.171696122255195,
   0.171191491927138,
   0.170741203452394,
   0.170352623535935,
   0.170030484571720,
   0.169778769131383,
   0.169600279312261,
   0.169497203311438,
   0.169471674316463,
   0.169523824256620,
   0.169650570148848,
   0.169847791817340,
   0.170109795984355,
   0.170429164062312,
   0.170800528921690,
   0.171220587568306,
   0.171687856317267,
   0.172201844286200,
   0.172763587167147,
   0.173377435421211,
   0.174048312038363,
   0.174781032014672,
   0.175580063521497,
   0.176448382103306,
   0.177387507555974,
   0.178396184905014,
   0.179473030482701,
   0.180619195047271,
   0.181836173167012,
   0.183124985564580,
   0.184486564693928,
   0.185922199504459,
   0.187433531467394,
   0.189021659035329,
   0.190688256270605,
   0.192435227083845,
   0.194262342171322,
   0.196168183784743,
   0.198153504627027,
   0.200218989535455,
   0.202363331861224,
   0.204581836231829,
   0.206866874087116,
   0.209209145616688,
   0.211598046183068,
   0.214021947664224,
   0.216467178719580,
   0.218909204462126,
   0.221319218325831,
   0.223669151752427,
   0.225933928307547,
   0.228089893221069,
   0.230113231532013,
   0.231982473785474,
   0.233679598504499,
   0.235190029631559,
   0.236502209897544,
   0.237604736174897,
   0.238485683117098,
   0.239133263849470,
   0.239540169759198,
   0.239701563514221,
   0.239613286095694,
   0.239274726761085,
   0.238689561491648,
   0.237864167375491,
   0.236806272329358,
   0.235526343161743,
   0.234036898044193,
   0.232351143644870,
   0.230484729719725,
   0.228455278908583,
   0.226282324836488,
   0.223987599443593,
   0.221593827278607,
   0.219124159907433,
   0.216603069805318,
   0.214058172009373,
   0.211516449093744,
   0.209002553258219,
   0.206533799304978,
   0.204121811000536,
   0.201775468980078,
   0.199503654854363,
   0.197315805669060,
   0.195221696631703,
   0.193230705539589,
   0.191350509323032,
   0.189581705392132,
   0.187922019090030,
   0.186368880788370,
   0.184918635117169,
   0.183566818541315,
   0.182307505859755,
   0.181134515943806,
   0.180042248526823,
   0.179026639084637,
   0.178084846331493,
   0.177215409187794,
   0.176413858931321,
   0.175674548607674,
   0.174992045379677,
   0.174361804017384,
   0.173781731124415,
   0.173250300822484,
   0.172765687715882,
   0.172325647670779,
   0.171927744469906,
   0.171570771154459,
   0.171257467510427,
   0.170992243445184,
   0.170780362517395,
   0.170628926043057,
   0.170543468830042,
   0.170528295939906,
   0.170586048081979,
   0.170718022237426,
   0.170924428651865,
   0.171201904868434,
   0.171545449677014,
   0.171950553478175,
   0.172413307583798,
   0.172930847646009,
   0.173499650773704,
   0.174115474298161,
   0.174772580726771,
   0.175460542645916,
   0.176166215793879,
   0.176876372529849,
   0.177577859418332,
   0.178258249729385,
   0.178906171831620,
   0.179512643705590,
   0.180072709043068,
   0.180584235616358,
   0.181047406641783,
   0.181466782813113,
   0.181849108000499,
   0.182200893908266,
   0.182527012101021,
   0.182830743565158,
   0.183112223601305,
   0.183369668683984,
   0.183602951941688,
   0.183814153031633,
   0.184006884738883,
   0.184185648142260,
   0.184355159271328,
   0.184519642394686,
   0.184682050155473,
   0.184844659731014,
   0.185009728971382,
];


// angulos retirados
var x = [
   -3.1416,
   -3.1241,
   -3.1067,
   -3.0892,
   -3.0718,
   -3.0543,
   -3.0369,
   -3.0194,
   -3.0020,
   -2.9845,
   -2.9671,
   -2.9496,
   -2.9322,
   -2.9147,
   -2.8972,
   -2.8798,
   -2.8623,
   -2.8449,
   -2.8274,
   -2.8100,
   -2.7925,
   -2.7751,
   -2.7576,
   -2.7402,
   -2.7227,
   -2.7053,
   -2.6878,
   -2.6704,
   -2.6529,
   -2.6354,
   -2.6180,
   -2.6005,
   -2.5831,
   -2.5656,
   -2.5482,
   -2.5307,
   -2.5133,
   -2.4958,
   -2.4784,
   -2.4609,
   -2.4435,
   -2.4260,
   -2.4086,
   -2.3911,
   -2.3736,
   -2.3562,
   -2.3387,
   -2.3213,
   -2.3038,
   -2.2864,
   -2.2689,
   -2.2515,
   -2.2340,
   -2.2166,
   -2.1991,
   -2.1817,
   -2.1642,
   -2.1468,
   -2.1293,
   -2.1118,
   -2.0944,
   -2.0769,
   -2.0595,
   -2.0420,
   -2.0246,
   -2.0071,
   -1.9897,
   -1.9722,
   -1.9548,
   -1.9373,
   -1.9199,
   -1.9024,
   -1.8850,
   -1.8675,
   -1.8500,
   -1.8326,
   -1.8151,
   -1.7977,
   -1.7802,
   -1.7628,
   -1.7453,
   -1.7279,
   -1.7104,
   -1.6930,
   -1.6755,
   -1.6581,
   -1.6406,
   -1.6232,
   -1.6057,
   -1.5882,
   -1.5708,
   -1.5533,
   -1.5359,
   -1.5184,
   -1.5010,
   -1.4835,
   -1.4661,
   -1.4486,
   -1.4312,
   -1.4137,
   -1.3963,
   -1.3788,
   -1.3614,
   -1.3439,
   -1.3265,
   -1.3090,
   -1.2915,
   -1.2741,
   -1.2566,
   -1.2392,
   -1.2217,
   -1.2043,
   -1.1868,
   -1.1694,
   -1.1519,
   -1.1345,
   -1.1170,
   -1.0996,
   -1.0821,
   -1.0647,
   -1.0472,
   -1.0297,
   -1.0123,
   -0.9948,
   -0.9774,
   -0.9599,
   -0.9425,
   -0.9250,
   -0.9076,
   -0.8901,
   -0.8727,
   -0.8552,
   -0.8378,
   -0.8203,
   -0.8029,
   -0.7854,
   -0.7679,
   -0.7505,
   -0.7330,
   -0.7156,
   -0.6981,
   -0.6807,
   -0.6632,
   -0.6458,
   -0.6283,
   -0.6109,
   -0.5934,
   -0.5760,
   -0.5585,
   -0.5411,
   -0.5236,
   -0.5061,
   -0.4887,
   -0.4712,
   -0.4538,
   -0.4363,
   -0.4189,
   -0.4014,
   -0.3840,
   -0.3665,
   -0.3491,
   -0.3316,
   -0.3142,
   -0.2967,
   -0.2793,
   -0.2618,
   -0.2443,
   -0.2269,
   -0.2094,
   -0.1920,
   -0.1745,
   -0.1571,
   -0.1396,
   -0.1222,
   -0.1047,
   -0.0873,
   -0.0698,
   -0.0524,
   -0.0349,
   -0.0175,
         0,
    0.0175,
    0.0349,
    0.0524,
    0.0698,
    0.0873,
    0.1047,
    0.1222,
    0.1396,
    0.1571,
    0.1745,
    0.1920,
    0.2094,
    0.2269,
    0.2443,
    0.2618,
    0.2793,
    0.2967,
    0.3142,
    0.3316,
    0.3491,
    0.3665,
    0.3840,
    0.4014,
    0.4189,
    0.4363,
    0.4538,
    0.4712,
    0.4887,
    0.5061,
    0.5236,
    0.5411,
    0.5585,
    0.5760,
    0.5934,
    0.6109,
    0.6283,
    0.6458,
    0.6632,
    0.6807,
    0.6981,
    0.7156,
    0.7330,
    0.7505,
    0.7679,
    0.7854,
    0.8029,
    0.8203,
    0.8378,
    0.8552,
    0.8727,
    0.8901,
    0.9076,
    0.9250,
    0.9425,
    0.9599,
    0.9774,
    0.9948,
    1.0123,
    1.0297,
    1.0472,
    1.0647,
    1.0821,
    1.0996,
    1.1170,
    1.1345,
    1.1519,
    1.1694,
    1.1868,
    1.2043,
    1.2217,
    1.2392,
    1.2566,
    1.2741,
    1.2915,
    1.3090,
    1.3265,
    1.3439,
    1.3614,
    1.3788,
    1.3963,
    1.4137,
    1.4312,
    1.4486,
    1.4661,
    1.4835,
    1.5010,
    1.5184,
    1.5359,
    1.5533,
    1.5708,
    1.5882,
    1.6057,
    1.6232,
    1.6406,
    1.6581,
    1.6755,
    1.6930,
    1.7104,
    1.7279,
    1.7453,
    1.7628,
    1.7802,
    1.7977,
    1.8151,
    1.8326,
    1.8500,
    1.8675,
    1.8850,
    1.9024,
    1.9199,
    1.9373,
    1.9548,
    1.9722,
    1.9897,
    2.0071,
    2.0246,
    2.0420,
    2.0595,
    2.0769,
    2.0944,
    2.1118,
    2.1293,
    2.1468,
    2.1642,
    2.1817,
    2.1991,
    2.2166,
    2.2340,
    2.2515,
    2.2689,
    2.2864,
    2.3038,
    2.3213,
    2.3387,
    2.3562,
    2.3736,
    2.3911,
    2.4086,
    2.4260,
    2.4435,
    2.4609,
    2.4784,
    2.4958,
    2.5133,
    2.5307,
    2.5482,
    2.5656,
    2.5831,
    2.6005,
    2.6180,
    2.6354,
    2.6529,
    2.6704,
    2.6878,
    2.7053,
    2.7227,
    2.7402,
    2.7576,
    2.7751,
    2.7925,
    2.8100,
    2.8274,
    2.8449,
    2.8623,
    2.8798,
    2.8972,
    2.9147,
    2.9322,
    2.9496,
    2.9671,
    2.9845,
    3.0020,
    3.0194,
    3.0369,
    3.0543,
    3.0718,
    3.0892,
    3.1067,
    3.1241,
    3.1416
];


var tout = 0; // timeout
var mlat = 40.634159099;
var mlg = -8.6600008;
var socket;
var btstart;
var slide ;
var check;
var rvalue;
var cnv;
var teta = 0;
// data to send para o veículo
var dataSend = {
	speed:0,
	sent:1,
};

//Estado para o veículo.
var carstats = { velc:10,sent:1, lat:40.634171,lg:-8.66,h:0,m:0,s:0,gpspd:0,gpst:5,bat:61};
var z = 0;
//tamnho do caanvas.
var w = 700;
var h = 700;
function setup(){
	// load as imagens retiradas.
	img = loadImage("direction.png");
	img2 = loadImage("battery.png");
	img3 = loadImage("wifi.png");
	img4 = loadImage("no-wifi.png");
	img5 = loadImage("placeholder.png");
	btstop = select('#bstop');
	btstart = select('#bstart');
	rvalue = select('#rangeValue');
	btstart.mouseClicked(sendMessage);
	btstop.mouseClicked(reset);
	slide = select('#sld');
	check = select('#sw');
	


	socket = io.connect('192.168.137.50:3000');
	socket.on('rcvRF',function(msg){
		var int8view = new Uint8Array(msg);
		carstats.velc = int(int8view[4]);
		carstats.sent = int8view[5];
		carstats.lg = (int8view[6] & 0xFF) | ((int8view[7] << 8) & 0x00FF00) | ((int8view[8] << 16) & 0x00FF0000) | ((int8view[9] << 24) & 0x00FF000000);
		carstats.lat = (int8view[10] & 0xFF) | ((int8view[11] << 8) & 0x00FF00) | ((int8view[12] << 16) & 0x00FF0000) | ((int8view[13] << 24) & 0x00FF000000);
		carstats.h = int8view[14];
		carstats.m = int8view[15];
		carstats.s = int8view[16];
		carstats.gpspd = int8view[17];
		carstats.gpst = int8view[18];
		carstats.bat = int(int8view[19]);
		

		carstats.lat = (carstats.lat/100000000)+40;
		carstats.lg = (carstats.lg/100000000)*(-1)-8;	
		tout = 0;
		
		teta =atan2((carstats.lg-mlg),(carstats.lat-mlat)); // cálculo do angulo.
		console.log(carstats.lat + " " + carstats.lg + " " + carstats.gpst + " "  + "  " + teta*180/PI + " " + carstats.gpspd+ " " + carstats.sent);
			
	});
	socket.on('timeout',function(){
			tout=1;
		});
	 
	
	cnv=createCanvas(w,h);
	cnv.parent('#main_content');
	
}

function draw(){
	background(238);
	stroke(0,61,110);
	translate(350,350);
	line(-350,-350,-350,350);
	
	
	//noStroke();
	textSize(100);
	fill(0,61,110);
	strokeWeight(2);
	textAlign(CENTER);


	image(img,-17,-150);

	text(carstats.velc,0,0);
	fill(0,61,110);
	strokeWeight(2);
	textSize(25);
	text("km/h",0,30);
	
	image(img5,-60,50);
	strokeWeight(1);
	textSize(15);
	if(carstats.gpst == 1)
		text("SPS",0,75);
	else if(carstats.gpst ==2)
		text("DGPS",0,75);
	else if(carstats.gpst ==4)
		text("RTK",0,75);
	else if(carstats.gpst ==5)
		text("FRTK",0,75);
	else
		text("NONE",0,75);
		
		
	image(img2,-60,90);
		text(carstats.bat,0,115);
		text("V",15,115);
		if(tout == 1)
			image(img4,-15,140);
		else
			image(img3,-15,140);
	
	fill(255);
	printCircuit();
	printCar();
//	if(z>= x.length)
//		z = 0;

	//arc(y[]*cos(x[z])*1200,y[z]*sin(x[z])*1200,20,20,0,2*PI);
	//z++;
}
function printCar(){
	
	 strokeWeight(5);
	 fill(226,21,47);
	var k  = 0;
	for(k = 0; k<y.length; k++)
	{
		if(x[k]>teta)
		{
		arc(y[k]*cos(x[k]-PI/2 )*1200,y[k]*sin(x[k]-PI/2)*1200,20,20,0,2*PI);
		break;
		}
	}
	//console.log(teta);
//	console.log(x[i]);
	//arc(y[k]*cos(x[k]*180/PI)*1200,y[k]*sin(x[k]*180/PI)*1200,20,20,0,2*PI);
	//console.log("x :" + y[i]*cos(x[i]*180/PI)*1200);
	//console.log("y :" + y[i]*sin(x[i]*180/PI)*1200);
	//arc(y[i]*cos(x[i])*1200,y[i]*sin(x[i]),20,20,0,2*PI);
//	 arc(spline(angl,x,y)*cos(angl)*1200,spline(angl,x,y)*sin(angl)*1200,20,20,0,2*PI);
 }



function printCircuit(){
	
	var j = 0;
	strokeWeight(10);
	for(j ; j<x.length-1 ; j++)
		line(y[j]*cos(x[j]-PI/2)*1200,y[j]*sin(x[j]-PI/2)*1200,y[j+1]*cos(x[j+1]-PI/2)*1200,y[j+1]*sin(x[j+1]-PI/2)*1200);
}





function sendMessage(){
	dataSend.speed= slide.value();
	dataSend.sent = check.checked();
	
	socket.emit('carstate',dataSend);
}

function reset(){
	slide.value(0);
	rvalue.value(0);
	sendMessage();
}
